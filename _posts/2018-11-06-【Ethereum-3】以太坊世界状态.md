---
layout:  post  # 使用的布局（不需要改）
catalog: true  # 是否归档
author: 陈国林 # 作者
tags:          #标签
    - Ethereum
---

# 一. 比特币`状态`
比特币的`状态`是通过网络中全局的未使用交易输出（UTXO）来刻画的，比特币网络中价值的传递通过交易来进行。  
更准确地说，一个比特币用户能使用一个或多个 UTXO 来创建一笔交易，所消耗的 UTXO 将作为交易的输入。 

1. 比特币的 UTXO 不能被拆分消耗  
   如果一个比特币用户想要花费 0.5 个比特币（他手上只有一个价值 1 比特币的 UTXO），他必须显式地将赋予 0.5 个比特币转账地址（转给自己）作为找零。  
   如果他们没有设置自我找零，那么 0.5 个比特币就会作为矿工打包交易的奖励转给矿工。  
2. 在一个最底层的角度来说，比特币并不保存用户的账户余额。在比特币中，用户仅仅在某一给定时间点掌握着一到多个 UTXO 的私钥。  
   用户的账户余额在比特币网络中是一种抽象的概念，事实上一个用户的余额是他所控制的每一个 UTXO （用户保管着对应的私钥）价值的和。用户所使用的私钥能对每一个 UTXO 进行签名和消费。

![](https://github.com/chenguolin/chenguolin.github.io/blob/master/data/image/bitcoin-tx.png?raw=true)

UTXO 系统在比特币网络中运行良好，某种程度上要归功于数字钱包能完成绝大多数与交易相关的工作，包括但不限于以下几点

1. 操作 UTXO 
2. 保存私钥 
3. 设置交易费用 
4. 提供找零地址 
5. 统计 UTXO (显示可用余额、转帐中的数额以及总余额)

# 二. 以太坊世界状态
和比特币不同，以太坊世界状态已经能管理账户余额以及更多信息了。  
以太坊中的状态并不是一种抽象的概念，它是以太坊的基础层协议，以太坊是一个基于所有交易的`状态机`。

1. 和其他区块链一样，以太坊区块链是由创世区块开始的，从这个起点开始（创世状态在 0 区块高度），诸如交易、合约以及挖矿的活动会持续不断地改变以太坊区块链的状态。
2. 在以太坊中，账户余额（存储在状态树中）随每一次交易进行所发生的改变就是这样一个例子。  
   值得留意的是，像账户余额这样的数据并不直接保存在以太坊区块链的区块中。区块中只保存交易树、状态树和收据树的根节点哈希值。其存储结构如下图所示。
   ![](https://github.com/chenguolin/chenguolin.github.io/blob/master/data/image/ethereum-world-state.png?raw=true)

 从上图中可以注意到，存储树（所有智能合约数据存储的位置）的根节点哈希实际上指向了状态树，从而间接指向了区块链。  
 
 以太坊中存在两种截然不同的数据类型
 1. 永久数据: 交易就是永久数据的一个例子。一旦一个交易被确认，它就将永久地被记录在交易树结构中，并且无法篡改。
 2. 暂存数据: 而某一个特定以太坊账户的余额则是暂存数据的例子，账户地址的余额存储在状态树中，并且每当接收到和该账户有关的交易时，该余额都会改变。  
    将挖矿确认后的交易这样的永久数据和账户余额这样的暂存数据分开管理是有意义的。以太坊使用前缀树这种数据结构（上图所示结构）来管理数据。
    
# 三. 以太坊前缀树    
## ① 状态前缀树
以太坊中有且只有一个全局状态前缀树，这个全局状态树在不断地更新着。这个状态前缀树包含了以太坊网络中每一个账户的一组键值对。 
这个 `键` 是一个 160 位的标识符（以太坊账户的地址），全局状态前缀树中的 `值` 是通过编码以太坊账户中的如下细节来得到的（使用递归长度前缀编码 （RLP） 的方法

1. nonce 值 
2. 余额 
3. 存储前缀树根节点哈希 
4. 代码哈希 
5. 状态前缀树的根节点（在给定时间点整个状态树的哈希值）是用来确保状态前缀树安全的唯一标志符，状态前缀树的根节点是由整个内部状态树的全部数据来通过密码学手段得到的

![](https://github.com/chenguolin/chenguolin.github.io/blob/master/data/image/ethereum-state-trie.png?raw=true)

## ② 存储前缀树
存储前缀树是存储智能合约数据存储，每一个以太坊账户都有自己的存储前缀树。在全局状态前缀树中保存着存储前缀树根节点的 256 位哈希 storageRoot 值。

![](https://github.com/chenguolin/chenguolin.github.io/blob/master/data/image/ethereum-storage-trie.png?raw=true)

## ③ 交易前缀树
每一个以太坊区块都有着自己的独立的交易前缀树。  
一个区块往往包括多笔交易，而交易的顺序当然由打包交易的矿工来决定。在交易前缀树中找到一笔交易的路径是通过（RLP 编码方法）检索交易在区块中的索引来得到的。  
已经被挖矿验证过的区块将永远不会再更新，所以区块中的交易顺序也将固定下来。这就意味着一旦你从区块的交易前缀树中定位到了某一笔交易，你日后就可以通过相同的路径找回它。 

![](https://github.com/chenguolin/chenguolin.github.io/blob/master/data/image/ethereum-tx-trie.png?raw=true)

 
     
