---
layout:  post  # 使用的布局（不需要改）
catalog: true  # 是否归档
author: 陈国林 # 作者
tags:          #标签
    - 优秀
---

# 一. 背景
做为一名互联网开发人员来说工作是永远做不完的，我们每天都得面对很多的事情，面对这么多的事情每个人都有不同的做事方式。
我比较喜欢的方式是通过文档总结的方式来呈现，在做一件事情之前先通过文档梳理清楚，通过文档方式告知相关人员我们需要做的事情，有利于互相理解。

这篇文章主要会介绍如何写好一篇"工作事项"文档，也就是具体某个工作事项文档。

# 二. 工作事项
工作事项文档应该分为以下7个部分，`现状`、`优化`、`收益`、`调整`、`风险`、`checklist`、`上线后收益`

1. 现状  
   `现状`这部分需要写我们要做的这个具体事情的现状是什么样子的，目前的数据情况、存在的问题等
2. 优化  
   `优化`这部分需要写针对目前这个现状我们需要做哪些优化，具体优化的点是什么，优化方案的描述
3. 收益  
   `收益`这部分需要写的是针对这次优化，我们预估能达到的收益，最好能有数据的指标，通过数据说话
4. 调整  
   `调整`这部分需要写针对这次优化，有哪些组件需要做调整，需要一一写明并注释清楚是由哪些同学负责
5. 风险  
   `风险`这部分需要写这次优化可能存在的风险点，这些风险点需要找谁确认
6. checklist  
   `checklist`这部分需要写的是这个优化要达到上线状态，需要check哪些点，这些点都是由谁负责
7. 上线后收益  
   `上线后收益`这部分在我们上线完成之后再加上，做每个事情我们都需要有个最终的结果，通过结果导向告诉其他人最终的效果
   
# 三. 样例
```
一. 现状
   1. 日志kafka topic数量多、分区数多、副本数多、保留天数长，导致kakfa有非常大量的索引文件。kafka启动加载索引文件等操作会导致启动时间非常久，所以目前kafka重启速度慢。
   2. kafka运行时占用资源大，一出问题要处理比较长的时间，影响到业务的监控和日志查询问题排查等使用

二. 优化
   1. kafka优化
      1).减少topic数量: 相同服务只需要一个topic，不再和stage、streamType关联
      2).优化topic配置: 新创建topic，pre环境默认3个分区、1个副本、保留时长为3天，release环境默认为3个分区、2个副本、保留时长为3天
      3).优化topic创建: kafka 设置为不自动创建topic，避免创建大量的topic
      4).kafka环境独立: k8s pre、release环境kafka资源独立，不同环境使用不同kafka资源
   2. 业务日志优化
      1).推动top业务对日志进行优化，确保业务输出即合理

三. 收益
   1. 减少Kafka资源使用，topic数量预计能减少为原来的1/4，分区数从10个减少为3个
   2. Kafka故障恢复时间变短
   3. 容器日志平台运维效率提高

四. 调整
   根据以上几点，综合目前日志全链路流程，我们会有以下相关的事项需要做调整
   1. Matrix平台 【@张三 @李四】
      1). 日志配置UI修改 ...
      2). 权限控制 ...
   2. Fluentd组件【@国林】
      1). Fluentd filter_addtopic插件支持根据 annotation是否有new_topic字段进行新老topic设置
      2). 新老topic规则对比，可以少创建很多topic
   3. ELK日志处理 【@王五】
      1). 修改定时发现topic, 更新logstash配置脚本
      2). 修改定时新增index-pattern脚本，业务如果使用新的topic规则，需要按新规则创建的index pattern
      3). 修改es日常定时任务脚本
   4. Kafka组件【@陈六】
      1). 关闭自动创建topic ...
      2). 清理掉老的topic ...
 
五. 风险
   1. 使用的新的topic规则后，会重启业务服务，重启之后Matrix是否能保证业务服务正常 【@张三 @李四】
   2. 如果有业务基于ELK配置了告警，那需要替换成使用新的topic相关的数据做告警，否则会导致告警失效 【@陈六】
   3. 使用新的topic后，监控告警流程会受影响，告警能否准确 【@王五】
   
六. checklist
   1. ELK日志处理流程脚本修改更新, 支持发现新topic并创建新的index pattern【@陈六】
   2. Matrix后端更新, 支持新topic功能 【@张三 @李四】
   3. Matrix前端更新, 支持根据新老topic开关查看Kibana日志 【@王五】
   4. Fluentd K8s ds更新, 支持日志写入新topic 【@国林】
   5. kafka 关闭自动创建topic 【@周八】
   6. kafka 老topic清理，topic关键字k8s，末尾为_stdout或_stderr (需要让苑卜、时光不消费老topic)【@周八 @国林】
   
七. 上线后的收益
   1. kafka topic数由原来1000个减少到450个，减少了550个topic
   ...
```
