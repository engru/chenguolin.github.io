---
layout:  post  # 使用的布局（不需要改）
catalog: true  # 是否归档
author: 陈国林 # 作者
tags:          #标签
    - K8s
---

# 一. 背景
当我们的设备断电的时候，我们需要考虑的一个点是我们的应用程序应该要如何处理这个事件。需要注意的是，当我们把电源拔掉的时候，电源其实并不是立即断电的。
我们的应用程序需要能够去处理这种事件，同时保存相应的应用状态。

对应的，我们会有以下几种可能的处理方式

1. 将内存中的所有内容保存到磁盘，然后在下次启动时将存储在磁盘上的内容恢复到内存中，但是这种方案有个问题就是从存储到磁盘和从磁盘恢复是一个缓慢的过程。
2. 使用一个文件来存储电源状态，其中0表示电源打开，1表示电源关闭，但是这种方法意味着系统中运行的进程应该跟踪存储在文件中的这个位。
3. 系统内核发送类似 `SIGTERM` 的信号给进程，进程自己去处理这个信号

对于应用容器来说，优雅退出重不重要完全取决于应用本身，这篇文章我们会讨论在Kubernetes和Docker中如何优雅退出容器。

# 二. 信号
`信号是一种软件中断的方式，用于一个进程与另一个进程通信的一种方式，例如操作系统和硬件`。所谓中断，是指当进程接收到一个信号时。它会停止做它正在做的事情，并通过对它做一些事情或忽略它来处理它。

Linux相关的信号如下所示，关于更多信号可以从 [sys/signal.h](https://unix.superglobalmegacorp.com/Net2/newsrc/sys/signal.h.html) 获取。

```
Signal     Value     Action   Comment
----------------------------------------------------------------------
SIGHUP        1       Term    Hangup detected on controlling terminal
                              or death of controlling process
SIGINT        2       Term    Interrupt from keyboard
SIGQUIT       3       Core    Quit from keyboard
SIGILL        4       Core    Illegal Instruction
SIGABRT       6       Core    Abort signal from abort(3)
SIGFPE        8       Core    Floating point exception
SIGKILL       9       Term    Kill signal
SIGSEGV      11       Core    Invalid memory reference
SIGPIPE      13       Term    Broken pipe: write to pipe with no
                              readers
SIGALRM      14       Term    Timer signal from alarm(2)
SIGTERM      15       Term    Termination signal
SIGUSR1   30,10,16    Term    User-defined signal 1
SIGUSR2   31,12,17    Term    User-defined signal 2
SIGCHLD   20,17,18    Ign     Child stopped or terminated
SIGCONT   19,18,25    Cont    Continue if stopped
SIGSTOP   17,19,23    Stop    Stop process
SIGTSTP   18,20,24    Stop    Stop typed at tty
SIGTTIN   21,21,26    Stop    tty input for background process
SIGTTOU   22,22,27    Stop    tty output for background process
```

举个例子

1. 当我们按下 `ctrl+c` 的时候相当于发送 `SIGINT` 信号
2. 当我们按下 `ctrl+z` 的时候相当于发送 `SIGTSTP` 信号
3. 当我们输入 `fg` 或 `bg` 命令的时候相当于发送 `SIGCONT` 信号

# 三. 容器优雅退出
## ① docker
1. 当我们使用 `docker stop` 命令stop一个容器的时候，docker会先发送 `SIGTERM` 信号给容器内1号进程，如果在`10s内`进程没有及时结束，内核会继续发送`SIGKILL`信号直接结束进程。
2. 如果我们直接使用 `docker kill` 命令则会直接退出进程，容器内进程没有办法优雅退出。

## ② k8s
1. 当我们使用 `kubectl delete pods mypod` 命令删除一个pod的时候，它会先发送 `SIGTERM` 信号给容器内1号进程，如果在指定时间内进程没有结束，内核会继续发送 `SIGKILL` 信号直接结束进程，这个等待时间可以通过 pod的配置文件定义 `terminationGracePeriodSeconds`，默认值为`30s`。
2. 如果应用进程没有处理 `SIGTERM` 信号，那么应用进程将会收到 `SIGKILL` 信号，容器进程将会立即从ETCD删除，没有留时间给应用进程进行优雅退出。






