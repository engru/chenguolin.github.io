---
layout:  post    # 使用的布局（不需要改）
catalog: true   # 是否归档
tags:         #标签
    - EOS
---

# 资源整体介绍
资源是EOS中不可或缺的组成部分，也是一般计算机系统的组成部分，要想使用EOS资源，必须要将EOS进行抵押（CPU、NET）或者购买（RAM），当我们不需要的时候，可以进行赎回，也就是取消抵押（CPU、NET），也可以卖出（RAM）。
EOS中有四种资源: CPU，NET，RAM，存储（暂未使用），可以分为两类
  
1. 可转让资源：CPU、NET，可以转让或者借（租赁）给别人使用的，需要抵押和赎回，赎回一般3天后到账。这个会采用比例制，比如，当前EOS全网总共有10万个EOS抵押用于获得CPU的使用权，而你自己的就锁定(抵押)了1万个EOS在CPU资源上。那么，你能够使用全网所有cpu资源的10%的计算能力。当然这个是一个粗略的估算，EOS目前还引用了拥塞控制算法，因此这个值也不是固定的，是一个动态的数据。CPU和NET都是这种比例制的策略。
2. 不可转让资源：RAM、存储，只能自己使用，是用来买卖的，实时到账。RAM使用Bancor算法，简单来说，就是根据当前的EOS的总量和可用RAM的总量，来计算出来RAM的“价格”，当RAM剩余量很少的时候，价格就会飙升。
  * CPU 和 NET 是可以恢复的，RAM是不可恢复的，用完了就得买。CPU 和 NET 的恢复周期是1天，但是不会主动恢复，有交易触发时才会触发恢复；另外这个值根据weight, 会实时变动。对应EOS而言，虽然转账的操作不需要支付额外的手续费，但是每笔交易都需要消耗一定的资源，因此EOS的交易其实还是有一定的费用的。
  * RAM 当前主网是64G， 定价模型是BANCOR算法， EOS 启动修改系统参数需要BP节点达成共识来完成，具体是通过eosio.msig 这个多重签名来实现的，1.0.6会部署一个独立的合约eosio.sudo 给BP 做决议时使用。
3. 关于资源计费和配额的代码主要在 resource_limits.cpp, resource_limits_private.cpp和 transaction_context.cpp 这几个文件中
  * ./libraries/chain/resource_limits.cpp
  * ./libraries/chain/resource_limits_private.cpp
  * ./libraries/chain/transaction_context.cpp

# RAM介绍
在Dawn 3.0，系统初始RAM是32G，卖出RAM的价格就是买入RAM的价格，因此没有套利空间，但是这样不利于流通。因此在Dawn 4.0的时候，已经改为了根据市场价卖出了，因此现在买卖RAM有套利空间，并且买卖RAM都有手续费，手续费都给了系统账号eosio.ram。RAM的定价是根据Bancor算法来定价的。EOS中的RAM没有一个直接对应的物理内存关系，把它完全理解为BP中的内存也是不是非常正确的，它与BP节点中的内存会有一点点关系，但并不是一一对应关系。
RAM 的买卖，实质上是抵押EOS到系统账户eosio.ram中，就是说将eos转账到eosio.ram这个系统账户之中作为抵押，不论是购买ram(即抵押eos，获取ram)，还是卖出ram(即取回抵押的eos，释放ram)，都是参与者与eosio.ram之间的交互。

目前已经是64G的RAM了，这个可以通过 system_contract::setram来调整这个值，传入的变量max_ram_size，不得大于1024Tb，不过需要大部分BP节点共同签名才可以调用setram来更新。
RAM的定价是根据Bancor算法来定价的，买入和卖出RAM都需要收取0.5% EOS的手续费，手续费都给了系统账号eosio.ram。
    
1. 智能合约的运行需要消耗RAM，因此新建账号等需要RAM。
2. RAM 的买卖实质上是抵押EOS到系统账户eosio.ram中，而不是买方和卖方直接的交易。
3. 不论是购买ram(即抵押eos，获取ram)，还是卖出ram(即取回抵押的eos，释放ram)，都是参与者与系统账户之间的交互，该过程将会收取0.5%的手续费。
4. 买入RAM有两种计价方式： 买多少字节的RAM；买多少EOS的RAM。
5. 卖出RAM只有一种方式：多少字节的RAM。
   
# CPU/NET介绍
用户发送一笔交易信息后，区块生产者需要将交易打包生成区块，然后将区块通过网络同步给其它生产者，这个过程需要消耗一定网络带宽资源。当用户调用智能合约时，区块生产者需要根据智能合约地址查找合约代码，然后将代码加载到内存中执行，这个过程需要消耗一定的CPU算力。CPU计算资源的计量方式为，运行智能合约（交易也属于智能合约的一种）所消耗的时间，用户每次调用智能合约都会消耗一点计算资源，如果消耗为0则无法继续执行合约。
不论是CPU还是NET都是要抵押EOS才能获得的。前面的说明可以知道RAM资源是不存在恢复机制的，消耗了就没有了，而CPU和NET资源却是存在资源恢复的机制，当交易产生的时候会进行恢复。

NET、CPU 调用delegatebw 时用的单位是EOS，它是根据当前全网总的权重计算出来的。
1. CPU 的单位 微妙、毫秒、秒
2. 带宽的单位 bytes 、KiB 、MiB

一个值得注意的就是抵押有两种模式，可以理解为租赁和赠送
1. 租赁，也就是租借，表示的是暂时的租给被人使用，使用权可以是别人的，但是相关的投票权还是属于我的、所有权也还是我自己的，赎回后也将回归到我自己的账号中。
2. 赠送，也就是过户，表示的完全送给别人使用，所有使用权、所有权都将属于别人，赎回后就是回归到别人的账号中，投票权也属于别人
3. 实际开发中有一个transfer字段来表示这两种模式。
  * transfer如果是true，表示赠送。 如果是false，表示租赁。
  * 对应客户端，transfer = 1 表示赠送，transfer = 0 表示租赁。
  * 自己不能赠送给自己，只能是租赁模式。

CPU 和 NET都是通过抵押的方式获取的，抵押的时候，资源马上进入自己的账号，但是也可以赎回，赎回抵押的 NET 和CPU一般是在三天之后 (72小时后) 才能到账。取消抵押EOS所减少的资源，也是和抵押对应起来的，即：抵押多少，赎回时候能够收回多少EOS。

CPU和NET采用比例制，比如，当前EOS全网总共有10万个EOS抵押用于获得CPU的使用权，而你自己的就锁定(抵押)了1万个EOS在CPU资源上。那么，你能够使用全网所有cpu资源的10%的计算能力。带宽也是一样。因此抵押EOS所获取的CPU和NET资源是根据全网的比例来的

EOS系统中，cpu和net资源是通过抵押eos获取的。抵押的时候只记录了抵押cpu/net对应的eos数量，获取到的资源不是固定的，而是在使用的时候会按照当前你所抵押eos的数量占全网抵押总量的比例实时计算的，最终体现为 limit 的值。实时计算由 eos/libraries/chain/resource_limits.cpp 中 get_account_net_limit_ex 和 get_account_cpu_limit_ex 方法实现。
