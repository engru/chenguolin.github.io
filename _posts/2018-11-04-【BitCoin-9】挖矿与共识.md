---
layout:  post  # 使用的布局（不需要改）
catalog: true  # 是否归档
author: 陈国林 # 作者
tags:          #标签
    - BitCoin
---

# 一. 介绍
## ① 挖矿
新比特币产生的过程称为**挖矿**，比特币的发行必须通过挖矿产生。挖矿的节点称为**矿工**，比特币挖矿有以下几个特点

1. 比特币大约每**10**分钟产生一个新块
2. 比特币总量为**2100**万，挖矿产生新的比特币每**4**年减半，初始奖励为**50BTC**，到**2140**年挖矿不再产生新的比特币
3. 挖矿会得到两种奖励**新币奖励**和**交易手续费**，交易手续费是每笔交易的输入和输出的差

`比特币发行与时间的关系`
![](http://upload-images.jianshu.io/upload_images/1785959-8940ef3f6c6357d4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## ② 共识
传统的支付系统都需要依赖一个中心化认证机构，依赖中心化认证机构背书来验证并处理所有的交易
比特币做为一个去中心化的点对点网络系统并没有中心化的认证机构，它的共识是通过所有的节点自发达成的，共识包含以下4个过程

1. 每个节点对新的交易进行验证
2. 节点进行工作量证明计算，挖矿成功节点把交易打包进区块
3. 每个节点对新的区块进行验证
4. 每个节点将最新的区块加入最长链

# 二. 交易验证
每一个比特币节点收到一个新的交易的时候都需要对交易做校验，验证通过的交易会通过网络传播给相邻的节点，验证不通过的交易则会被丢弃

验证通常包括以下几点
1. 交易的语法和数据结构必须正确
2. 输入与输出列表都不能为空
3. 交易的字节大小必须小于MAX_BLOCK_SIZE
4. 每一个输入值必须在规定值的范围内
5. 每一个输出值必须在规定值的范围内
6. 交易输入没有包含coinbase
7. nLockTime值符合规定要求
8. 交易的字节大小必须大于等于100
9. 交易中的签名数量(SIGOPS)应小于签名操作数量上限
10. 对于每一个输入引用的输出是必须存在的并且没有被花费
11. 对于每一个输入如果引用的输出存在于交易池中任何其它的交易中，该交易将被丢弃
12. 如果输入值的总和小于输出值的总和交易将被丢弃
13. 如果交易费用太低交易将被丢弃
14. 每一个输入的解锁脚本必须依据相应输出的锁定脚本来验证

# 三. 交易打包
交易验证通过后会被加到交易池也称Mempool中等待节点挖矿成功加入新的区块
## ① coinbase交易
区块中的第一笔交易是笔特殊交易，称为创币交易或者coinbase交易。与常规交易不同coinbase交易没有输入不会消耗UTXO，它只包含一个被称作coinbase的输入，仅仅用来创建新的比特币。创币交易有一个输出，用于输出到这个矿工的比特币地址。
```
{
"hex" : "01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0f03443b0403858402062f503253482fffffffff0110c08d9500000000232102aa970c592640d19de03ff6f329d6fd2eecb023263b9ba5d1b81c29b523da8b21ac00000000",
"txid" : "d5ada064c6417ca25c4308bd158c34b77e1c0eca2a73cda16c737e7424afba2f",
"version" : 1,
"locktime" : 0,
"vin" : [
  {
  "coinbase" : "03443b0403858402062f503253482f",
  "sequence" : 4294967295
  }
],
"vout" : [
  {
  "value" : 25.09094928,  //包括挖矿奖励+矿工费
  "n" : 0,
  "scriptPubKey" : {
      "asm": "02aa970c592640d19de03ff6f329d6fd2eecb023263b9ba5d1b81c29b523da8b21OP_CHECKSIG",
      "hex" : "2102aa970c592640d19de03ff6f329d6fd2eecb023263b9ba5d1b81c29b523da8b21ac",
      "reqSigs" : 1,
      "type" : "pubkey",
      "addresses" : ["1MxTkeEP2PmHSMze5tUZ1hAV3YTKu2Gh1N"]
  }
  }
]
}
```

## ② coinbase交易结构
常规的交易输入结构如下
![](http://upload-images.jianshu.io/upload_images/1785959-4b0689f622fae44f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

coinbase交易输入结构如下
![](http://upload-images.jianshu.io/upload_images/1785959-dfe0a126593d1973.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## ③ 矿工费
节点挖矿的矿工费等于当前区块所有交易的输入和减去输出和
`Total Fees = Sum(Inputs) - Sum(Outputs)`

## ④ 构建区块头
为了构造区块头，挖矿节点需要填充六个字段，如下所示
![](http://upload-images.jianshu.io/upload_images/1785959-1815d9f1d57ee8f6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

1. Version:  例如版本号的字段值为2，长度为4字节，以小端格式编码值为 0x20000000
2. Previous Block Hash: 例如前一个区块号为277315，它的哈希值为**0000000000000002a7bbd25a417c0374cc55261021e8a9ca74442b01284f0569**
3. Merkle Root: merkle root字段需要将全部的交易组成一个merkle树，交易包括coinbase交易和常规的交易，这些交易的哈希值逐层地、成对地组合，直到最终组合并成一个根节点。例如merkle root值为**c91c008c26e50763e9f548bb8b2fc323735f73577effbc55502c51eb4cc7cf2e**
4. Timestamp: 4个字节的时间戳，每秒都在变化
5. Target: 挖矿目标值，每2016个块调整一次
6. Nonce: 随机数从0开始

## ⑤ 构建区块
比特币挖矿过程使用的是**SHA256**哈希函数，​无论输入的大小是多少SHA256函数的输出的长度总是256bit。
`比特币的挖矿采用的POW(工作量证明算法)，简单的说挖矿就是重复计算区块头的哈希值，不断修改区块头相关参数，直到计算得到哈希值小于目标值即挖矿成功`

​节点挖矿成功后会立即将这个区块发给它的所有相邻节点，这些节点在接收并验证这个新区块后会继续传播此区块。当挖矿节点收到并验证了这个新区块后，它们会放弃之前对构建这个相同高度区块的计算，并立即开始计算下一个区块的工作。

## ⑥ 难度调整
比特币难度决定了挖矿目标值，`目标值 = 最大目标值 / 难度值`难度值变大的时候目标值变小，难度值变小的时候目标值变大。

比特币平均每**10**分钟出一个块，它是如何保证平均10分钟出一个块的呢？

每个节点会独立调整挖矿难度，每**2016**个块就会调整一次难度。难度的调整公式是由最新2016个区块的花费时长与**20160**分钟比较得出的。简单来说，如果网络发现区块产生速率比10分钟要快时会增加难度，如果发现比10分钟慢时则降低 难度。

`New Difficulty = Old Difficulty * (20160 minutes / Actual Time of Last 2016 Blocks)`

为了防止难度的变化过快，每个周期的调整幅度必须小于一个因子值为**4**。如果要调整的幅度大于4倍，则按4倍调整所以在下一个2016区块的周期不平衡的情况会继续存在，所以进一步的难度调整会在下一周期进行。

# 四. 区块验证
当新区块在网络中传播时，每一个节点都会进行一系列的验证，这确保了只有有效的区块会在网络中传播。校验包括以下几点
1. 区块的数据结构正确
2. 区块头的哈希值小于目标值
3. 区块时间戳在验证时间点2小时之内
4. 区块大小在长度限制之内
5. 第一个交易必须是coinbase交易
6. 区块内的所有交易必须有效

# 五. 区块上链
当节点接收到新区块，它会尝试将这个区块插入到现有区块链中。节点会看一下这个区块的“previous block hash”字段，这个字段是该区块对其父区块的引用。同时，新的节点将尝试在已存在的区块链中找出这个父区块。

如果节点收到了一个有效的区块，而在现有的区块链中却未找到它的父区块，那么这个区块被认为是“孤块”。孤块会被保存在孤块池中，直到它们的父区块被节点收到。一旦收到了父区块并且将其连接到现有区块链上，节点就会将孤块从孤块池中取出，并且连接到它的父区块，让它作为区块链的一部分。当两个区块在很短的时间间隔内被挖出来，节点有可能会以相反的顺序接收到它们，这个时候孤块现象就会出现。

# 六. 挖矿和算力
比特币挖矿算力发展，如下所示
![](http://upload-images.jianshu.io/upload_images/1785959-9c09f7243c5849cc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

随着算力发展难度变化，如下所示
![](http://upload-images.jianshu.io/upload_images/1785959-64a274ed95aebf3d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

