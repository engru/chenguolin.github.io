---
layout:  post  # 使用的布局（不需要改）
catalog: true  # 是否归档
author: 陈国林 # 作者
tags:          #标签
    - 架构
---

# 一. 前言
近2年**区块链**成为互联网新贵，自从2017年比特币价格从1万飙到最高12万人民币的时候区块链成为了整个行业的热潮。仅管2018年由于整个经济大环境不好影响了整个币市行情，但是这并不影响我们做为区块链从业人员研究技术。

2008年中本聪发布**比特币白皮书**至今10年，市面上出现了许多的数字货币钱包，从最早的比特币钱包再到后面的以太坊钱包以及现在的EOS钱包。按照不同的维度钱包可以分成不同类型，根据端类型可以分成网页版钱包、APP钱包以及命令行钱包等，根据私钥是否触网可以分成冷钱包和热钱包，根据数据存储可以分为全节点钱包和轻节点钱包等等。

总而言之，**钱包**本质上是一个管理用户私钥的工具，任何人拿到了私钥都可以操控你的数字货币，所以想做好一款数字货币钱包也并非一件易事。

下面我将从几个方面简单的写一下开发一个数字货币APP钱包大致需要做哪些事情，欢迎拍砖^_^。

# 二. 整体架构
一般来说一个APP整体网络架构如下所示，至上而下分成几个部分。 
![](https://github.com/chenguolin/chenguolin.github.io/blob/master/data/image/APP%E6%9E%B6%E6%9E%84%E5%9B%BE.png?raw=true)

1. 前端: 用户交互部分包括客户端native和客户端内嵌H5，前端通过**HTTPS/HTTP**接口请求后端提供API接口。
2. 加速: 通常使用CDN进行访问加速，请求会先经过CDN节点再到后端服务实例。
3. 负载均衡: 后端服务通常对应有多个实例所以一般会使用nginx或则lvs来做负载均衡，通过nginx可以做访问控制、健康检查以及自动化恢复等事情。
4. 后端: 真正的后端HTTP服务，通常是多实例部署，很多时候会有一个管理后台来配合项目管理和开发。
5. 存储: 底层存储媒介，例如Mysql、Redis、Kafka或者一些大数据存储组件等等。

# 三. 人员分配
开发一个APP离不开各种各样角色的人员参与，一个DAU在10万左右的APP可能只需要约20个人的小团队就可以搞定了，但是像淘宝、支付宝、微信等巨头APP来说他们的人员就多的多，通常会是几百上千人同时参与，所以我列举的是一个普通的APP的人员分配。

1. 项目经理
    * 人数: 1
    * 职责: 项目整体负责人，负责资源调配、把控项目进度同时控制可能存在的风险。
2. 产品经理
    * 人数: 3+
    * 职责: 构思产品需求、画产品原型图并且出对应的产品PRD和文档描述。
3. UI设计师
    * 人数: 1
    * 职责: 负责设计产品经理PRD上的原型UI。
4. 后端开发
    * 人数: 5
    * 职责: 负责实现后端代码功能，维护后端整体功能稳定性。
5. 客户端开发
    * 人数: Android、iOS 各3
    * 职责: 负责客户端代码功能实现，客户端版本升级迭代。
6. 前端开发
    * 人数: 3
    * 职责: 负责前端代码功能实现，例如官网、H5等功能。
7. 测试开发
    * 人数: 3
    * 职责: 负责整体客户端、后端、前端的测试需求，包括自动化测试、回归测试和功能测试等。
8. 运维
    * 人数: 1
    * 职责: 负责项目整体运维部署，保证整个项目服务稳定性，故障快速修复处理等。
9. 安全
    * 人数: 1
    * 职责: 负责项目整体的安全测试，扫描前后端项目代码，减少项目安全隐患。

# 四. 架构设计
## ① 前端
### 功能
1. APP官网: 通常一个APP需要有一个WEB官网，官网通常也是由前端来负责实现
2. H5: APP的功能开发通常不是由纯粹的native组成还需要有一些H5页面，H5的好处是更新升级方便不用受限于APP的升级发布。H5通常也由前端来负责实现。

### 实现
1. 前端开发基本都是HTML+JS+CSS，JS框架有Jquery、Reactjs、Angularjs等，CSS有Bootstraps等

### 部署
1. 前端通常需要有一个域名，域名解析到指定部署机器80端口。
2. 前端部署通常前后端分离，静态页面部署。nginx代理80端口访问到默认html文件，内部用js就可以处理所有页面的逻辑了。
    
## ② 客户端
### 功能
1. 钱包创建、导入和删除
    * 钱包创建: 使用BIP44标准的HD钱包，默认生成单路径钱包，创建完成后私钥加密存储在客户端本地。
    * 钱包导入: 支持助记词导入、私钥导入，如果是以太坊钱包还支持KeyStore导入。
    * 钱包删除: 客户端本地删除直接删除即可。
2. 转账和收款
    * 转账: 客户端本地计算好签名，然后直接请求节点提供的RPC接口。节点包括比特币节点、以太坊节点以及EOS节点。
    * 收款: 客户端只需要展示收款交易记录即可。
3. 交易记录
    * 交易记录: 客户端请求后端接口获取，后端需要存储每个地址每个token相关的交易记录。
4. 行情展示
    * 行情数据: 客户端请求后端接口获取，后端需要提前从第三方网站上抓取、解析并结构化入库存储。
5. 资讯展示
    * 资讯数据: 客户端请求后端接口获取，后端需要提前从第三方网站上抓取、解析并结构化入库存储。
6. 中心化钱包
    * 钱包内涉及到中心化相关的功能，这部分和普通的APP没啥区别，概况起来就是后端提供数据，客户端进行展示。
7. APM监控上报
    * 客户端相关的性能监控，客户端需要把客户端本身的各种行为数据上报，方便问题排查和优化。
    * 拿到监控数据后后续可以做各种监控例如网络错误率、tcp建连时间等等。 
 
### 实现
1. Android客户端开发语言是JAVA，一般使用IDEA做为开发IDE。
2. iOS客户端开发语言是Objective-C，一般使用AppCode做为开发IDE。

### 发布
1. Android客户端发布通常是提交到应用分发平台，例如Google Play国内的各种应用商店等。
2. iOS客户端升级发布需要提交到AppStore给苹果进行审核，审核通过后会释放给用户下载。   
    
## ③ 加速
1. CDN核心功能用于请求访问加速，国内比较出名的CDN有网宿、金山、七牛还有阿里云、腾讯云、同兴等。
2. CDN引入虽然是用于访问加速，但是对于HTTPS/HTTP请求来说却多了1次DNS解析、TCP建连、SSL握手的耗时。
3. CDN上可以配置请求域名是否支持跨域等。

## ④ 负载均衡
1. 通常使用nginx做为负载均衡器，关于nginx的功能在这里就不在深入介绍和描述。
2. 总的来说nginx做以下几个方面的事情
    * 请求转发配置，多个实例之间实现负载均衡
    * 请求代理配置，例如从国内走专线代理到国外AWS
    * 流量摘除，想要下线某个服务的话可以直接在nginx把配置去掉就类似把服务下线了
    * 健康检查，nginx上可以检查后端服务是否还健康存活
    
## ⑤ 后端
后端是整个APP最核心的功能之一，后端通常负责实现所有和客户端、前端交互的接口实现，以及各种管理后台等用于项目的配置管理。

### 功能
1. 区块链节点: 节点是公链的核心钱包开发厂商需要自行部署节点
    * BTC节点: 使用bitcoin core代码后的bitcoind
    * ETH节点: 使用go-ethereum编译后的geth
    * EOS节点: 使用EOSIO官方代码或者docker镜像
2. APP Service: 统一的API服务提供给客户端、前端调用
    * 开发框架: Golang + Gin (区块链大多数使用Golang开发)
    * 提供功能: 提供HTTPS接口给客户端调用，负责提供客户端需要的数据，包括交易记录、行情、资讯等等。
3. 管理后台: 统一的管理平台进行项目管理配置
    * 开发框架
        * 前端: HTML+JS+CSS
        * 后端: Golang + Gin (提供接口给前端调用)
    * 提供功能: 提供接口给前端调用

### 实现
1. 区块链相关的服务大部分都采用Golang编写，Golang版本为1.10+即可
2. 使用Golang dep做为依赖库来管理项目依赖，使用Golint来规范项目代码

### 运维部署
1. 项目构建
    * jenkins构建rpm、docker镜像
    * gitlab ci构建rpm、docker镜像
2. 项目部署
    * rpm包安装部署
    * docker镜像安装部署

### 监控报警
1. 监控: 监控可以采用开源Grafana做展示，底层数据源来自influxdb和prometheus
     * ERROR日志监控: 进程打印ERROR日志监控
     * SLA监控: 运维在nginx层面统一做的监控例如请求数、慢请求、错误请求等
     * 进程监控: 监控进程本身的一些指标例如CPU、内存等
     * 业务监控: 业务自定义监控主要监控业务本身的一些数据
     * 机器监控: 磁盘监控、文件句柄监控等
2. 报警: 根据监控可以实现相应的报警机制，报警一般分成3个级别
     * 一般级别: 邮件报警
     * 高优级别: 短信报警 + 企业微信报警 + 邮件报警
     * 超高级别: 电话报警

### 安全防御
服务端安全也非常重要，安全防御主要在以下几个方面
1. API接口做签名校验，如果是给客户端的接口最安全的方式是使用私钥签名然后服务端用公钥验证签名保证请求不会被伪造和篡改
2. 后端代码mysql crud逻辑没有漏洞，例如不能有sql注入漏洞
3. mysql表重要的数据做加密，防止被人明文脱库
4. 重要的秘钥不能明文存储

## ⑥ 存储
最底层是存储层，常见的存储包括Mysql、Redis、MC、ELK等。
还有一些大数据的组件，例如HDFS、HBase等但是这些都不太适合用于在线实时访问，一般用于存储离线数据。

正常来说一个普通的APP底层存储只需要使用Mysql + Redis + InfluxDB + ELK 基本就能够满足了。
1. Mysql用于存储普通的数据
2. Redis可用于缓存存储一些热点数据，或者做为原子锁等
3. InfluxDB可用于存储时序数据，例如行情K线数据
4. ELK可用于存储大量数据，支持实时搜索

## ⑦ 统计分析
无论是前端、客户端还是服务端都有统计分析的需求，通过报表统计分析服务性能、业务数据。

数据收集: 前端、客户端的数据通过统一的APM上报，数据上报之后写入Kafka然后再使用Storm分析处理写入influxdb等；服务端数据则是通过自定义业务日志，通过统一的组件收集并处理后写入Hive表，再通过写Hive SQL统计各种业务结果。  
数据展示: 服务性能数据可以通过Kibana、Grafana等查看，Hive数据则可以通过专门的平台来展示

# 五. 项目管理
1. 文档管理: 使用的是confluence
2. 流程管理: 使用的是JIRA

